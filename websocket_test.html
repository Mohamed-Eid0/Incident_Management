<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Notifications Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .input-group {
            margin: 20px 0;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .disconnect-btn {
            background-color: #dc3545;
        }
        .disconnect-btn:hover {
            background-color: #c82333;
        }
        #notifications {
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
        }
        .notification {
            background-color: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .notification.ticket_created {
            border-left-color: #28a745;
        }
        .notification.ticket_assigned {
            border-left-color: #ffc107;
        }
        .notification.work_started {
            border-left-color: #17a2b8;
        }
        .notification.work_finished {
            border-left-color: #6f42c1;
        }
        .notification.ticket_approved {
            border-left-color: #28a745;
        }
        .notification.ticket_rejected {
            border-left-color: #dc3545;
        }
        .notification-header {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 8px;
        }
        .notification-message {
            color: #555;
            margin-bottom: 8px;
        }
        .notification-details {
            font-size: 12px;
            color: #888;
        }
        .clear-btn {
            background-color: #6c757d;
            float: right;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîî Real-Time Notifications Test</h1>
        
        <div id="status" class="status disconnected">
            Disconnected
        </div>
        
        <div class="input-group">
            <label for="token">JWT Access Token:</label>
            <input type="text" id="token" placeholder="Paste your JWT access token here">
        </div>
        
        <button id="connectBtn" onclick="connectWebSocket()">Connect</button>
        <button id="disconnectBtn" class="disconnect-btn" onclick="disconnectWebSocket()" disabled>Disconnect</button>
        <button class="clear-btn" onclick="clearNotifications()">Clear Notifications</button>
        
        <h2>Notifications</h2>
        <div id="notifications"></div>
    </div>

    <script>
        let ws = null;
        let pingInterval = null;

        function connectWebSocket() {
            const token = document.getElementById('token').value.trim();
            
            if (!token) {
                alert('Please enter your JWT access token');
                return;
            }

            // Close existing connection if any
            if (ws) {
                ws.close();
            }

            // Create WebSocket connection
            const wsUrl = `ws://localhost:8000/ws/notifications/?token=${token}`;
            ws = new WebSocket(wsUrl);

            ws.onopen = function(e) {
                console.log('WebSocket connection established');
                updateStatus(true);
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;
                
                // Start ping interval (every 30 seconds)
                pingInterval = setInterval(() => {
                    if (ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({
                            type: 'ping',
                            timestamp: new Date().toISOString()
                        }));
                    }
                }, 30000);
            };

            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log('Notification received:', data);
                
                if (data.type === 'connection_established') {
                    addNotification({
                        notification_type: 'connection',
                        message: data.message,
                        ticket: {},
                        timestamp: new Date().toISOString()
                    });
                } else if (data.type === 'pong') {
                    console.log('Pong received');
                } else {
                    addNotification(data);
                }
            };

            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
                alert('WebSocket connection error. Check console for details.');
            };

            ws.onclose = function(event) {
                console.log('WebSocket connection closed', event);
                updateStatus(false);
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
                
                if (pingInterval) {
                    clearInterval(pingInterval);
                    pingInterval = null;
                }
                
                if (event.code === 4001) {
                    alert('Authentication failed. Please check your token.');
                }
            };
        }

        function disconnectWebSocket() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function updateStatus(connected) {
            const statusDiv = document.getElementById('status');
            if (connected) {
                statusDiv.className = 'status connected';
                statusDiv.textContent = '‚úì Connected to WebSocket';
            } else {
                statusDiv.className = 'status disconnected';
                statusDiv.textContent = '‚úó Disconnected';
            }
        }

        function addNotification(data) {
            const notificationsDiv = document.getElementById('notifications');
            const notificationDiv = document.createElement('div');
            notificationDiv.className = `notification ${data.notification_type}`;
            
            const typeEmoji = {
                'connection': 'üîó',
                'ticket_created': 'üé´',
                'ticket_opened': 'üìÇ',
                'ticket_assigned': 'üë§',
                'work_started': 'üöÄ',
                'work_finished': '‚úÖ',
                'ticket_approved': '‚úîÔ∏è',
                'ticket_rejected': '‚ùå'
            };
            
            const emoji = typeEmoji[data.notification_type] || 'üì¢';
            
            let detailsHTML = '';
            if (data.ticket && data.ticket.id) {
                detailsHTML = `
                    <div class="notification-details">
                        <strong>Ticket #${data.ticket.id}</strong>: ${data.ticket.title || 'N/A'}
                        ${data.ticket.priority ? `<br>Priority: ${data.ticket.priority_display}` : ''}
                        ${data.ticket.status ? `<br>Status: ${data.ticket.status_display}` : ''}
                    </div>
                `;
            }
            
            notificationDiv.innerHTML = `
                <div class="notification-header">
                    ${emoji} ${data.notification_type.replace(/_/g, ' ').toUpperCase()}
                </div>
                <div class="notification-message">${data.message}</div>
                ${detailsHTML}
                <div class="notification-details">
                    <em>${new Date(data.timestamp).toLocaleString()}</em>
                </div>
            `;
            
            notificationsDiv.insertBefore(notificationDiv, notificationsDiv.firstChild);
            
            // Play notification sound (optional)
            playNotificationSound();
        }

        function clearNotifications() {
            document.getElementById('notifications').innerHTML = '';
        }

        function playNotificationSound() {
            // Create a simple beep sound
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }

        // Auto-connect if token is in localStorage (optional)
        window.onload = function() {
            const savedToken = localStorage.getItem('jwt_token');
            if (savedToken) {
                document.getElementById('token').value = savedToken;
            }
        };

        // Save token to localStorage when changed
        document.getElementById('token').addEventListener('change', function(e) {
            localStorage.setItem('jwt_token', e.target.value);
        });
    </script>
</body>
</html>
